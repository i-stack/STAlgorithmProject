# iOS 消息转发流程 探究

> OC方法调用的本质是给对象发送消息:objc_msgSend()，这个流程可以分为三个阶段
> > 消息发送
> > 
> > 动态方法解析
> > 
> > 消息转发

## **消息发送**

* ***函数原型***

```
void objc_msgSend(void /* id self, SEL op, ... */)

其中第一参数是消息接收者，后面是要执行的方法。
```
* ***查找源码***

> 打开runtime源码 -> 搜索objc_msgSend -> 找到objc-msg-arm64.s文件 -> 找到ENTRY _objc_msgSend。
> 
> 汇编 使用 ENTRY + 函数名字作为一个函数的入口
> 
> END_ENTRY + 函数名字 函数结束

* ***_objc_msgSend***
```
ENTRY _objc_msgSend
	UNWIND _objc_msgSend, NoFrame

	cmp	p0, #0			// nil check and tagged pointer check
#if SUPPORT_TAGGED_POINTERS
	b.le	LNilOrTagged		//  (MSB tagged pointer looks negative)
#else
	b.eq	LReturnZero
#endif
	ldr	p13, [x0]		// p13 = isa
	GetClassFromIsa_p16 p13, 1, x0	// p16 = class
LGetIsaDone:
	// calls imp or objc_msgSend_uncached
	CacheLookup NORMAL, _objc_msgSend, __objc_msgSend_uncached

#if SUPPORT_TAGGED_POINTERS
LNilOrTagged:
	b.eq	LReturnZero		// nil check
	GetTaggedClass
	b	LGetIsaDone
// SUPPORT_TAGGED_POINTERS
#endif

LReturnZero:
	// x0 is already zero
	mov	x1, #0
	movi	d0, #0
	movi	d1, #0
	movi	d2, #0
	movi	d3, #0
	ret

	END_ENTRY _objc_msgSend
```
