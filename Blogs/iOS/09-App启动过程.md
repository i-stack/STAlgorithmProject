# App 启动过程

* **App的启动分为冷启动和热启动**

> 冷启动：App点击启动前，它的进程不在系统里，需要系统新创建一个进程分配给它启动的情况。这是一次完整的启动过程。
> 
> 热启动：App在冷启动后用户将App退后台，App的进程还在系统里的情况下，用户重新启动进入App的过程，这个过程做的事情非常少。

* **App的启动时间**

指的是从用户点击App开始，到用户看到第一个界面之间的时间。总结来说，App的启动主要包括三个阶段：

> 1、main()函数执行前；
> 
> 2、main()函数执行后；
> 
> 3、首屏渲染完成后。

* **main()函数执行前**

> 加载可执行文件（App的.o文件的集合）；
> 
> 加载动态链接库，进行 rebase 指针调整和 bind 符号绑定；
> 
> Objc 运行时的初始处理，包括 Objc 相关类的注册、category 注册、selector 唯一性检查等；
> 
> 初始化，包括了执行 +load() 方法、attribute((constructor)) 修饰的函数的调用、创建 C++ 静态全局变量。

这个阶段启动速度优化可以从以下几个方面进行：

> 减少动态库加载。每个库本身都有依赖关系，在使用动态库的数量较多时，尽量将多个动态库进行合并。数量上，苹果公司建议最多使用`6`个非系统动态库。
> 
> 减少加载启动后不会去使用的类或者方法。
> 
> `+load()`方法里的内容可以放到首屏渲染完成后再执行，或使用 `+initialize()` 方法替换掉。因为，在一个 `+load()` 方法里，进行运行时方法替换操作会带来`4毫秒`的消耗。不要小看这4毫秒，积少成多，执行`+load()`方法对启动速度的影响会越来越大。
> 
> 控制C++全局变量的数量。

* **main() 函数执行后**

指的是从`main()`函数执行开始，到`appDelegate`的`didFinishLaunchingWithOptions`方法里首屏渲染相关方法执行完成。

首页的业务代码都是要在这个阶段，也就是首屏渲染前执行的，主要包括：

> 首屏初始化所需配置文件的读写操作；
> 
> 首屏列表大数据的读取；
> 
> 首屏渲染的大量计算等。

* **首屏渲染完成后**

首屏渲染后的这个阶段，主要完成的是，非首屏其他业务服务模块的初始化、监听的注册、配置文件的读取等。

从函数上来看，这个阶段指的就是截止到 didFinishLaunchingWithOptions 方法作用域内执行首屏渲染之后的所有方法执行完成。

简单说的话，这个阶段就是从渲染完成时开始，到 didFinishLaunchingWithOptions 方法作用域结束时结束。

这个阶段用户已经能够看到 App 的首页信息了，所以优化的优先级排在最后。

但是，那些会卡住主线程的方法还是需要最优先处理的，不然还是会影响到用户后面的交互操作。

明白了App启动阶段需要完成的工作后，我们就可以有的放矢地进行启动速度的优化了。

这些优化，包括了功能级别和方法级别的启动优化。接下来，我们就从这两个角度展开看看。

# Objc 运行时的初始处理

* **void _objc_init(void)**

`_objc_init(void)`主要做了下面几件事：

> 1、这个函数只会调用一次
>> ```
>> static bool initialized = false;
>> if (initialized) return;
>> initialized = true;
>> ```
> 2、`environ_init()`，读取影响运行时的环境变量，如果需要的话，也可以打印环境变量
> 
> 3、`tls_init()`，线程key的绑定
> 
> 4、`static_init()`，主要是运行系统级别的C++静态构造函数
> 
> 5、`runtime_init()`，运行时的初始化，主要分为两个操作：
> 
  >> 1、开辟存储分类的表：objc::unattachedCategories.init(32);
  >> 
  >> 2、开辟存储类的表：objc::allocatedClasses.init();
>
> 6、`exception_init()`，初始化libobjc的异常处理系统
> 
> 7、`cache_t::init()`，全局缓存初始化
> 
> 8、`_imp_implementationWithBlock_init()`，启动回调机制
> 
> 9、`_dyld_objc_notify_register(&map_images, load_images, unmap_image)`，注册在映射、取消映射和初始化`dyld`的镜像时要调用的处理程序
